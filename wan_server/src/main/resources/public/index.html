<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 73%;
        width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #dashboard {
        margin: 1em;
      }
      #header > p {
        font-weight: bold;
        margin-bottom: auto;
      }
      #header + div {
        font-weight: bold;
        margin-top: 0.8em;
        margin-bottom: 0.5em;
      }
      select {
        margin-right: 0.5em;
        margin-left: 0.5em;
      }
      input {
        margin-right: 0.5em;
        margin-left: 0.5em;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <!-- Use of jQuery, a popular Javascript framework, is made in order to soften manipulation of HTML elements -->
    <script src="jquery-3.2.1.min.js"></script>
    
    <script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4, // (World : 2)
          center: new google.maps.LatLng(63.330054, 26.493659), // World: new google.maps.LatLng(2.8,-187.3),
          mapTypeId: 'terrain'
        });
      }
      
      /* topos = {
        "France": { "nodes": [...], "links": [...] },
        "USA": {"nodes": [...], "links":[...] },
        ...
       }
      */
      var topos = {};
      
      /* nodes = {
		      "USA": {
		        "Denver": {lat: ..., lng: ...},
		        "Dallas": {lat: ..., lng: ...},
		        ...
		      },
		      "France": ...,
		      ...
		    }
		  */
      
		  var nodes = {};
      
		  /* polylines =(same format as)= polylinesShowingShortestPaths = {
		      "USA": [Polyline, Polyline, ...],
		      "France": [...],
		      ...
		   }
		  */
		  var polylines = {};
		  var polylinesShowingShortestPaths = {};
		  
      var countries = ["USA", "China", "Germany", "France", "Finland"];
      var zoom_info = { // Where to zoom the map for each country? Center + zoom level
        World: { center: {lat: 47.044448, lng: 13.983138}, zoom: 2 },
        USA: { center: {lat: 41.878791, lng: -98.007661}, zoom: 3 },
        China: { center: {lat: 35.197462, lng: 105.955927}, zoom: 4 },
        France: { center: {lat: 46.562695, lng: 3.355229}, zoom: 5 },
        Germany: { center: {lat: 50.951823, lng: 10.684529}, zoom: 5 },
        Finland: { center: {lat: 63.330054, lng: 26.493659}, zoom: 4 }
      };
      
      $.when( // When all the JSON files are loaded...
          getJSON('USA.json'),
          getJSON('China.json'),
          getJSON('Germany.json'),
          getJSON('France.json'),
          getJSON('Finland.json')
        ).done(function (USA, China, Germany, France, Finland) {
          // Start drawing the networks on the maps
          topos["USA"] = USA[0];
          topos["China"] = China[0];
          topos["Germany"] = Germany[0];
          topos["France"] = France[0];
          topos["Finland"] = Finland[0];
          
          countries.map(function(country) {
            polylines[country] = [];
            polylinesShowingShortestPaths[country] = []; 
            drawTopology(country);
          });
          add_UI();
        });

      
      // Definitions of all functions needed:
      
      function getJSON(JSON_file) {
        return $.getJSON(JSON_file, function(topology) {
          return topology;
        });
      }
      
      function drawTopology(topo_Id, linksColor) {
        var topo = topos[topo_Id];
        nodes[topo_Id] = {};
        for (var i = 0; i < topo.nodes.length; i++) {
          var Lat = topo.nodes[i].latitude;
          var Lng = topo.nodes[i].longitude;
          var coordinates = {lat: Lat, lng: Lng};
          var label = topo.nodes[i].id;
          var country = topo.nodes[i].country;

          nodes[topo_Id][label] = coordinates;

          var infowincontent = document.createElement('div');
          var strong = document.createElement('strong');
          strong.textContent = label + ", " + country;
          infowincontent.appendChild(strong);     
          addCircle(coordinates, map, infowincontent);
        }

        for (var i = 0; i < topo.links.length; i++) {
          var source = topo.links[i].source;
          var target = topo.links[i].target;
          drawLink(source, target, topo_Id, linksColor);
        }
      }
      
      /*
      function drawNewTopology(new_topo, countryName) {
        console.log("calling drawNewTopology()");
        nodes["New_Topo"] = {};
        for (var i = 0; i < new_topo.nodes.length; i++) {
          var Lat = new_topo.nodes[i].latitude;
          var Lng = new_topo.nodes[i].longitude;
          var coordinates = {lat: Lat, lng: Lng};
          var label = new_topo.nodes[i].id;

          nodes["New_Topo"][label] = coordinates;

          var infowincontent = document.createElement('div');
          var strong = document.createElement('strong');
          strong.textContent = label + ", " + countryName;
          infowincontent.appendChild(strong);     
          addCircle(coordinates, map, infowincontent);
        }

        console.log(nodes);
        for (var i = 0; i < new_topo.links.length; i++) {
          var source = new_topo.links[i].source;
          var target = new_topo.links[i].target;
          drawLink(source, target, "New_Topo", "#00e000");
        }
      }*/
      
      function drawLink(source, target, topoId, color) {
        if (!color) {
          color = '#FFFF99';
        }
        var path = new Array(2);
        path[0] = nodes[topoId][source];
        path[1] = nodes[topoId][target];

        polyline = new google.maps.Polyline({
          path: path,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        polyline.setMap(map);
        polylines[topoId].push(polyline);
      }

      function addCircle(centerCoordinates, map, contentInfoWindow) {
        if (map === undefined) {
          map = this.map; // if not provided, the map is the map object such as defined right below the initMap() function's signature
        }
        var circle = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          map: map,
          center: centerCoordinates,
          radius: 2.5*10000 // fixed size, in meters
        });
        
        circle.setMap(map);
        
        if (contentInfoWindow) {
          circle.addListener('click', function(){
            addInfoWindow(centerCoordinates, contentInfoWindow, map);
            var input1 = $(':input[name="src"]');
            var input2 = $(':input[name="dest"]');
            if ( input1.val() === '' ) input1.val( $(contentInfoWindow).text() );
            else if (input2.val() === '') input2.val( $(contentInfoWindow).text() );
          });
        }
      }
        
      function addInfoWindow(coords, content, map) {
        var infoWindow = new google.maps.InfoWindow({
          content: content,
          position: coords
        });
        
        infoWindow.open(map);
      }
      
      function add_UI() {
        // Add a user dashboard below the map
        var $user_dashboard = $('<div>', { id: 'dashboard' }).appendTo('body');
        $('<label>Which country you want to highlight?</label>').appendTo($user_dashboard);
        console.log('label jqeuery'+$('<label>Which country you want to highlight?</label>'));
        // TODO: LOST MORE THAN TWO HOURS TRYING TO FIX THE STATEMENT BELOW, PLEASE HEEEEEEEEEEEELP!!!!!
        // 
        var $countryId = $('<select>', { /*on: { blur: function() { zoom(); }, change: function() { zoom(); } }*/ } );
        console.log('countryId: ' + $countryId);
        countries.map(function(country) {
          $('<option>', { text: country } ).appendTo($countryId);
        });
        console.log('countryId: ' + JSON.stringify($countryId));
        $countryId.appendTo($user_dashboard);
        $('<input type="checkbox" name="all" value="all" onclick="zoom(true);" checked>World<br>')
                  .appendTo($user_dashboard);
        
        // Add input fields for requesting Shortest path
        var $shortest_path_interface = $('<div>', { id: 'short_path_iface' }).appendTo($user_dashboard);
        var $shortest_path_header = $('<div>', { html: '<p>Shortest path:</p>', id: 'header' } );
        $shortest_path_header.appendTo($shortest_path_interface);
        $source_node_label = $('<label for="src">Source node:</label>');
        $dest_node_label = $('<label for="dest">Destination node:</label>');
        $input_src = $('<input>', { type: "text", placeholder: "Click a red circle", name:"src" });
        $input_dst = $('<input>', { type: "text", placeholder: "Click a red circle", name:"dest" });
        $source_node_label .appendTo($shortest_path_interface);
        $input_src         .appendTo($shortest_path_interface);
        $dest_node_label   .appendTo($shortest_path_interface);
        $input_dst         .appendTo($shortest_path_interface);
       
        $req_sp_button = $('<button>', { html: 'Request shortest path' }).click(request_shortest_path);
        $reset_sp_button = $('<button>', { html: 'Reset' }).css({'margin-left': '0.5em'}).click(reset_shortest_path_fields);
        $req_sp_button.appendTo($shortest_path_interface);
        $reset_sp_button.appendTo($shortest_path_interface);
        
        // Add input fields for requesting new graph
        var $new_graph_interface = $('<div>', { id: 'new_graph_iface' }).appendTo($user_dashboard);
        var $new_graph_header = $('<div>', { html: '<p>New graph (beta!):</p>', id: 'header', css: { 'display': 'inline-block' } } );
        $new_graph_header.appendTo($new_graph_interface);
        $country_new_graph = $('<select>', { type: "text", name: "newgraph"});
        countries.map(function(country) {
          $('<option>', { text: country } ).appendTo($country_new_graph);
        });
        $countryId.appendTo($new_graph_interface);
       
        $req_button = $('<button>', { html: 'Request new graph' }).click( request_new_graph );
        $req_button.appendTo($new_graph_interface);
      }
    
      function request_shortest_path() {
        console.log('shortestpath() called');
        var source_shortest_path = $(":input[name='src']").val();
        var dest_shortest_path = $(":input[name='dest']").val();
        if (source_shortest_path === '' || dest_shortest_path === '') {
          $('<div>', { html: 'Please provide a source and a destination' }).css({'color': 'red'}).appendTo('#dashboard');
          return;
        }
        countryId = source_shortest_path.substr( source_shortest_path.lastIndexOf(',') + 2 );
        // Special cases
        if (countryId == "United States") countryId = "USA";
        if (countryId == "Canada") countryId = "USA";
        if (countryId == "Switzerland") countryId = "France";
        
        // We build the request object to send to the server
        var request = {};
        request['country'] = countryId;
        request['src'] = source_shortest_path.substring( 0, source_shortest_path.lastIndexOf(',') );
        request['dst'] = dest_shortest_path.substring( 0, dest_shortest_path.lastIndexOf(',') );
        
        $.ajax({
          method: "POST",
          url: "/shortestpath",
          data: JSON.stringify(request),
          dataType: 'json'
        })
        .done(function( shortest_path ) { // shortest_path is an array of nodes constituting the shortest path
          console.log("JSON received successfully from the server:", JSON.stringify(shortest_path));
          var $shortest_info = $('<div>', { html: 'Shortest path found is: ' + shortest_path.join(' -> ') }).css({'color': 'green'});
          $('#shortest_path').after($shortest_info);
          highlightShortestPath(shortest_path, countryId);
        })
        .fail(function(jqXHR, textStatus, errorThrown ) {
          if (errorThrown == "") {
            var errmsg = "Nothing received from the server: server down, or no Internet connection"; 
            alert( errmsg );
          } else {
            alert(errorThrown);
          }
        });
      }
      
      function request_new_graph() {
        console.log('newgraph() called');
        var country_name = $(":input[name='newgraph']").val();
        
        var request = {};
        request['country'] = country_name;
        
        $.ajax({
          method: "POST",
          url: "/newgraph",
          data: JSON.stringify(request),
          dataType: 'json'
        })
        .done(function( new_topology ) { // new_graph is an object containing the fields 
          console.log("JSON received successfully from the server:", JSON.stringify(new_topology));
          topos["New_Topo"] = new_topology;
          polylines["New_Topo"] = [];
          console.log("going to draw topology!");
          drawTopology("New_Topo", "#00e000");
        })
        .fail(function(jqXHR, textStatus, errorThrown ) {
          if (errorThrown == "") {
            var errmsg = "Nothing received from the server: server down, or no Internet connection"; 
            alert( errmsg );
          } else {
            alert( errorThrown ); console.log("errorThrown: " + errorThrown);
          }
        });
      }
      
      function reset_shortest_path_fields() {
        $('#shortest_path input').val('');
      }
      
      /*
      function updatemap(userSelected) {
        // First check if the "All" checkbox is checked, unless a pair of datacenters has been explicitly selected
        if ( !userSelected && $("input:checkbox[value='all']").prop('checked') ) {
          displayAllLinks();
          return;
        }
        
        // Unselect automatically the "All" checkbox
        if (userSelected) {
          $("input:checkbox[value='all']").prop('checked', false);
        }
        
        var userSelection = $( 'select option:selected' ).text();
        
        removeAllLinks();
        displayLinksFromCountry(userSelection);
      }
      window.updatemap = updatemap; // export in global namespace, so the function can be accessed from the "onchange" event
      */
      function zoom(onWorld) {
        var country_selected;
        if (onWorld === true) {
          country_selected = 'World';
        } else {
          country_selected = $( '#zoom_input option:selected' ).text();
        }
        map.setCenter(zoom_info[country_selected].center); // center on country selected
        map.setZoom(zoom_info[country_selected].zoom); // center with the level of zoom pre-defined for this country
      }
      window.zoom = zoom;
      
      function displayLinksFromCountry(countryId) {
        polylines[countryId].map(function(polyline) {
          polyline.setMap(map);
        });
      }
      
      function displayAllLinks() {
        for (var country in polylines) {
          polylines[country].map(function(polyline) {
            polyline.setMap(map);
          });
        }
      }
      
      function removeAllLinks() {
        for (var country in polylines) {
          polylines[country].map(function(polyline) {
            polyline.setMap(null);
          });
        }
      }
      
      function highlightShortestPath(path, countryId) {
        var coords = [];
        
        path.map(function(nodeName) {
          coords.push(nodes[countryId][nodeName]);
        });
        
        var polyline = new google.maps.Polyline({
          path: coords,
          strokeColor: randomColor(),
          strokeOpacity: 1.0,
          strokeWeight: 2,
          zIndex: 10
        });
        polyline.setMap(map);
        polylinesShowingShortestPaths[countryId].push(polyline);
      }
      
      function randomColor() {
        rc = "#";
        for(i=0;i<6;i++){
          rc += Math.floor(Math.random()*16).toString(16);
        }
        return rc;
      }
      
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJeWErAFIm-5ALCAYlHl61ylmgKDDWBps&callback=initMap">
    </script>
  </body> 
</html>