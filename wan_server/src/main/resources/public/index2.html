<!DOCTYPE html>
<html>
  <head>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 73%;
        width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #dashboard {
        margin: 1em;
      }
      #shortest_path > p {
        font-weight: bold;
        margin-bottom: auto;
      }
      select {
        margin-right: 0.5em;
        margin-left: 0.5em;
      }
      input {
        margin-right: 0.5em;
        margin-left: 0.5em;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <!-- Use of jQuery, a popular Javascript framework, is made in order to soften manipulation of HTML elements -->
    <script src="jquery-3.2.1.min.js"></script>
    
    <script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: new google.maps.LatLng(2.8,-187.3),
          mapTypeId: 'terrain'
        });

        // Create a <script> tag and set the USGS URL as the source.
        var script = document.createElement('script');
        // This example uses a local copy of the GeoJSON located at
        // http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_week.geojsonp
        script.src = 'All_countries.js';
        document.getElementsByTagName('head')[0].appendChild(script);
      }

      // Loop through the JSONTopology object and place a marker for each
      // set of coordinates.
      

      window.All_countries = function(JSONTopology) {
        window.JSONTopology = JSONTopology;
        //console.log(JSONTopology);

        function addCircle(centerCoordinates, map, contentInfoWindow) {
          if (map === undefined) {
            map = this.map; // if not provided, the map is the map object such as defined right below the initMap() function's signature
          }
          var circle = new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: centerCoordinates,
            radius: 2.5*10000 // fixed size, in meters
          });
          
          circle.setMap(map);
          
          if (contentInfoWindow) {
            circle.addListener('click', function(){
              addInfoWindow(centerCoordinates, contentInfoWindow, map);
              var input1 = $(':input[name="fname"]');
              var input2 = $(':input[name="fname2"]');
              if ( input1.val() === '' ) input1.val( $(contentInfoWindow).text() );
              else if (input2.val() === '') input2.val( $(contentInfoWindow).text() );
            });
          }
        }
          
        function addInfoWindow(coords, content, map) {
          var infoWindow = new google.maps.InfoWindow({
            content: content,
            position: coords
          });
          
          infoWindow.open(map);
        }

        function Label2latLng(label) {
          for (var i in nodes) {
            if (nodes[i][0] === label) {
              return nodes[i][1];
            }
          }
          return new Error('label not found in the label set!');
        }


        var nodes = [];
        var paths = [];
        var polylines = [];
        var polylinesShowingShortestPaths = [];
        var polyline;
        
        // We make a list containing the per-country lists of nodes
        // And another list containing the per-country lists of links
        // Reminder: format of the JSON data for 5 countries:
        /* {
        	"nodes1": [
        		{
            		"Latitude": 36.17497, 
            		"Country": "United States", 
            		"Internal": 1, 
            		"id": "Las Vegas", 
            		"Longitude": -115.13722
        		},
        		...
        	],
		    "links1": [
       			 {
           		 	"LinkType": "DS-3", 
           			 "source": "Las Vegas", 
           		 	"LinkLabel": "45 Mbps DS-3", 
            		"LinkNote": "45 Mbps ", 
            		"target": "Phoenix"
        		},
        		...
        	],
        	"nodes2": ...,
        	...
           }
        */
        var listNodesPerCountry = new Array("nodes1","nodes2","nodes3","nodes4","nodes5");
        var listLinksPerCountry = new Array("links1","links2","links3","links4","links5");
        
        for (var num = 0; num < listNodesPerCountry.length; num++) { 
          var nodesCurrentCountry = listNodesPerCountry[num];
          var linksCurrentCountry = listLinksPerCountry[num];
       
          for (var i = 0; i < JSONTopology[nodesCurrentCountry].length; i++) {
            var Lat = JSONTopology[nodesCurrentCountry][i].Latitude;
            var Lng = JSONTopology[nodesCurrentCountry][i].Longitude;
            var coordinate = {lat: Lat, lng: Lng};
            var label = JSONTopology[nodesCurrentCountry][i].id; 
            var country =  JSONTopology[nodesCurrentCountry][i].Country;

            var node = new Array(2);
            node[0] = label;
            node[1] = coordinate;
            	nodes.push(node);

            var infowincontent = document.createElement('div');
            var strong = document.createElement('strong');
            strong.textContent = label + ", " + country;
            infowincontent.appendChild(strong);     
            addCircle(coordinate, map, infowincontent);

          }

          for (var j = 0; j < JSONTopology[linksCurrentCountry].length; j++) {
            var source = JSONTopology[linksCurrentCountry][j].source;
            var target = JSONTopology[linksCurrentCountry][j].target;
            var link = new Array(2);
            link[0] = source;
            link[1] = target;
            paths.push({link: link, countryId: num+1});
          }
        }
       
        for (var i in paths) {
          var path = paths[i].link.map(Label2latLng); // we assign [coord_src, coord_dst] to path
          
          polyline = new google.maps.Polyline({
            path: path,
            strokeColor: '#FFFF99',
            strokeOpacity: 1.0,
            strokeWeight: 2 // to be weighted according to number of paths that go across the link
          });
          polyline.setMap(map);
          polylines.push( {idcountry: paths[i].countryId, polyline: polyline} );
        }
        
        var countries = {
          'United States': 1,
          'Canada': 1,
          'China': 2,
          'Germany': 3,
          'France': 4,
          'Finland': 5
        }
      
        function add_UI() {
          var $user_dashboard = $('<div>', { id: 'dashboard' }).appendTo('body');
          $('<label>For which country you want to display the paths that go across it?</label>').appendTo($user_dashboard);
          var $countryId = $('<select>', { on: { blur: function() { updatemap(true); }, change: function() { updatemap(true); } } } );
          
          for (var c in countries) {
            $('<option>', { html: [countries[c] + ' ' + c] } ).appendTo($countryId);
          }
          $countryId.appendTo($user_dashboard);
          $('<input type="checkbox" name="all" value="all" onclick="updatemap();" checked>All<br>')
                    .appendTo($user_dashboard);
          
          var $shortest_path_params = $('<div>', { html: '<p>Shortest path:</p>', id: 'shortest_path' } );
          $shortest_path_params.appendTo($user_dashboard);
          $input1 = $('<input>', { type: "text", name:"fname"});
          $input2 = $('<input>', { type: "text", name:"fname2"});
          $input1.appendTo($shortest_path_params);
          $input2.appendTo($shortest_path_params);
          $input1.before('<label for="fname">Source hop</label>');
          $input2.before('<label for="fname2">Destination hop</label>');
         
          $req_button = $('<button>', { html: 'Request shortest path' }).click(senddata);
          $reset_button = $('<button>', { html: 'Reset' }).css({'margin-left': '0.5em'}).click(reset_dijkstra);
          $req_button.appendTo($shortest_path_params);
          $reset_button.appendTo($shortest_path_params);
        }
      
        function senddata() {
          console.log('senddata() called');
          /*var object = google.maps.geometry.spherical.interpolate(
                      new google.maps.LatLng($(":input[name='fname']").val(), -187.3),
                      new google.maps.LatLng($(":input[name='fname2']").val(),-150.5), 0.5);
          console.log(object.lat());
          */
          var topo = JSONTopology;
          var input1 = $(":input[name='fname']");
          var input2 = $(":input[name='fname2']");
          if (input1.val() === '' || input2.val() === '') {
            $('<div>', { html: 'Please provide a source and a destination' }).css({'color': 'red'}).appendTo('#dashboard');
            return;
          }
          topo['src'] = input1.val().substring( 0, input1.val().lastIndexOf(',') );
          topo['dst'] = input2.val().substring( 0, input2.val().lastIndexOf(',') );
          var country = input1.val().substr( input1.val().lastIndexOf(',') + 2 );
          topo['countryId'] = countries[country];
          // topo['cost'] = input3.val();
          
          $.ajax({
            method: "POST",
            url: "/senddata",
            data: JSON.stringify(JSONTopology),
            dataType: 'json'
          })
          .done(function( msg ) { // msg is for now an array of nodes constituting the shortest path
            console.log("JSON received successfully from the server:", JSON.stringify(msg));
            $('<div>', { html: 'Shortest path found is: ' + msg.join(' -> ') }).css({'color': 'green'}).appendTo('#dashboard');
            highlightShortestPath(msg, countries[country]);
          })
          .fail(function(jqXHR, textStatus, errorThrown ) {
            if (errorThrown == "") {
              var errmsg = "Nothing received from the server: server down, or no Internet connection"; 
              alert( errmsg );
            } else {
              alert(errorThrown);
            }
          });
        }
        
        function reset_dijkstra() {
          $('#shortest_path input').val('');
        }
        
        function updatemap(userSelected) {
          // First check if the "All" checkbox is checked, unless a pair of datacenters has been explicitly selected
          if ( !userSelected && $("input:checkbox[value='all']").prop('checked') ) {
            displayAllLinks();
            return;
          }
          
          // Unselect automatically the "All" checkbox
          if (userSelected) {
            $("input:checkbox[value='all']").prop('checked', false);
          }
          
          var userSelection = parseInt($( 'select option:selected' ).text());
          
          removeAllLinks();
          displayLinksFromCountry(userSelection);
        }
        window.updatemap = updatemap; // export in global namespace, so the function can be accessed from the "onchange" event
        
        function displayLinksFromCountry(countryId) {
          for (var i in polylines) {
            if ( polylines[i].idcountry === countryId ) {
              polylines[i].polyline.setMap(map);
            }
          }
        }
        
        function displayAllLinks() {
          for (var i in polylines) {
            polylines[i].polyline.setMap(map);
          }
        }
        
        function removeAllLinks() {
          for (var i in polylines) {
            polylines[i].polyline.setMap(null);
          }
        }
        
        function highlightShortestPath(path, countryId) {
          var coords = []
          for (var i in path) {
            for (var j in JSONTopology["nodes"+countryId]) {
              if (JSONTopology["nodes"+countryId][j].id === path[i]) {
                var lat = JSONTopology["nodes"+countryId][j].Latitude;
                var lng = JSONTopology["nodes"+countryId][j].Longitude;
                coords.push({lat:lat, lng:lng});
              }
            }
          }
          var polyline = new google.maps.Polyline({
            path: coords,
            strokeColor: randomColor(),
            strokeOpacity: 1.0,
            strokeWeight: 2,
            zIndex: 10
          });
          
          /* we make disappear all preceding shortest paths on the map (for now)
          for (var i in polylinesShowingShortestPaths) {
            polylinesShowingShortestPaths[i].setMap(null);
          }
          */
          polyline.setMap(map);
          polylinesShowingShortestPaths.push(polyline);
        }
        
        function randomColor() {
          rc = "#";
          for(i=0;i<6;i++){
            rc += Math.floor(Math.random()*16).toString(16);
          }
          return rc;
        }
        
        add_UI();
      }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJeWErAFIm-5ALCAYlHl61ylmgKDDWBps&callback=initMap">
    </script>
  </body> 
</html>